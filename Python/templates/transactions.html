{% extends "layout.html" %}
{% block title %}Transactions{% endblock %}

{% block content %}
<!-- Page heading -->
<h1 class="text-2xl font-semibold mb-4">Transactions</h1>

<!-- Search input field -->
<input
  type="text"
  id="searchInput"
  placeholder="Search..."
  class="mb-4 p-2 border rounded w-full max-w-sm"
/>

<!--
  CSS styles for the table and layout.
  We use CSS grid to create columns that auto-adjust width,
  and style headers, rows, cells, and the resize handle.
-->
<style>
  /* Grid container for the table using dynamic columns */
  #transactions {
    display: grid;
    grid-template-columns:
      {% for _ in transaction_headings %}
        /* Each column min 120px wide, grows to fill space equally */
        minmax(120px, 1fr){% if not loop.last %} {% endif %}
      {% endfor %};
  }

  /* Display thead, tbody, and tr as 'contents' to allow grid layout on cells */
  thead, tbody, tr {
    display: contents;
  }

  /* Table header styling */
  th {
    position: relative; /* For positioning resize handle */
    background-color: #f3f4f6;
    color: #111827;
    padding: 0.75rem 1rem;
    font-weight: 500;
    font-size: 0.875rem;
    text-align: left;
    white-space: nowrap; /* Prevent wrapping */
    cursor: pointer; /* Indicates sortable */
  }

  /* Table cell styling */
  td {
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    color: #374151;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* Truncate overflow text with ellipsis */
  }

  /* Zebra striping for even rows */
  tr:nth-child(even) td {
    background-color: #f9fafb;
  }

  /* The resize handle on right edge of headers */
  .resize-handle {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 2px;
    cursor: col-resize; /* Cursor changes on hover to indicate resizing */
    background: transparent;
    transition: background 0.2s ease;
  }

  /* Add border between columns except the last one */
  th:not(:last-child),
  td:not(:last-child) {
    border-right: 1px solid #e5e7eb;
  }

  /* Highlight resize handle on hover or while resizing */
  .resize-handle:hover,
  th.resizing .resize-handle {
    background: #a1a1aa;
  }

  /* Hide rows with this class (used by search filtering) */
  .hidden-row {
    display: none;
  }
</style>

<!-- Container to enable horizontal scrolling if table too wide -->
<div class="overflow-auto border rounded-md">
  <!-- Table element using CSS grid -->
  <table id="transactions">
    <caption class="sr-only">Transaction Table</caption> <!-- Accessibility -->

    <thead>
      <tr>
        <!-- Loop through column headers and output <th> elements -->
        {% for header in transaction_headings %}
        <th data-index="{{ loop.index0 }}">
          {{ header }}
          <!-- Resize handle div inside each header for column resizing -->
          <div class="resize-handle"></div>
        </th>
        {% endfor %}
      </tr>
    </thead>

    <tbody>
      <!-- Loop through all rows of transaction data -->
      {% for row in transaction_data %}
      <tr>
        <!-- Output each cell in the row -->
        {% for cell in row %}
        <td>{{ cell }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!--
  JavaScript to enable sorting, searching, and column resizing functionality
-->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const table = document.getElementById('transactions');
    const ths = table.querySelectorAll('thead th'); // All header cells
    const rows = Array.from(table.querySelectorAll('tbody tr')); // All body rows as array

    // --- Sorting functionality ---
    ths.forEach((th, index) => {
      th.addEventListener('click', () => {
        // Toggle 'asc' class on clicked header to track sort direction
        const asc = th.classList.toggle('asc');

        // Remove 'asc' and 'desc' classes from other headers to reset sorting icons/styles
        ths.forEach(h => h !== th && h.classList.remove('asc', 'desc'));

        // Toggle 'desc' class on current header opposite to asc
        th.classList.toggle('desc', !asc);

        // Sort rows array based on cell content in the clicked column (index)
        rows.sort((a, b) => {
          // Get text content of cells in the clicked column for both rows
          const aText = a.children[index].innerText.toLowerCase();
          const bText = b.children[index].innerText.toLowerCase();

          // Try date comparison first
          const aDate = Date.parse(aText); // Support comma decimal
          const bDate = Date.parse(bText);

          if (!isNaN(aDate) && !isNaN(bDate)) {
            // Numeric sort ascending or descending
            return asc ? aDate - bDate : bDate - aDate;
          }

          // Try numeric comparison
          const aNum = parseFloat(aText.replace(',', '.')); // Support comma decimal
          const bNum = parseFloat(bText.replace(',', '.'));

          if (!isNaN(aNum) && !isNaN(bNum)) {
            // Numeric sort ascending or descending
            return asc ? aNum - bNum : bNum - aNum;
          }

          // Fallback: alphabetical sort using localeCompare, ascending or descending
          return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
        });

        // Append sorted rows back into tbody to update display order
        const tbody = table.querySelector('tbody');
        rows.forEach(row => tbody.appendChild(row));
      });
    });

    // --- Search/filter functionality ---
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', () => {
      const term = searchInput.value.toLowerCase();

      // Show/hide rows depending if any cell contains the search term
      rows.forEach(row => {
        const match = Array.from(row.children).some(cell =>
          cell.innerText.toLowerCase().includes(term)
        );
        row.style.display = match ? '' : 'none';
      });
    });

    // --- Column resize functionality ---
    let isResizing = false;
    let startX, startWidth, colIndex;

    ths.forEach((th, index) => {
      const handle = th.querySelector('.resize-handle');
      if (!handle) return;

      handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        colIndex = index; // Store which column is resizing
        startX = e.pageX; // Initial mouse position on X axis
        startWidth = th.offsetWidth; // Current column width
        th.classList.add('resizing'); // Add CSS class for visual feedback
        document.body.style.cursor = 'col-resize'; // Change mouse cursor
        e.preventDefault(); // Prevent text selection etc
      });
    });

    // Track mouse movement globally to resize column live
    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const dx = e.pageX - startX; // How far mouse moved from start
      const newWidth = Math.max(80, startWidth + dx); // Minimum column width 80px

      // Get current grid template columns as array
      const cols = getComputedStyle(table).gridTemplateColumns.split(' ');

      // Update the resizing column width to new width in pixels
      cols[colIndex] = `${newWidth}px`;

      // Apply updated column widths back to the grid container
      table.style.gridTemplateColumns = cols.join(' ');
    });

    // Stop resizing on mouse up
    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        document.body.style.cursor = ''; // Reset cursor
        table.querySelector('th.resizing')?.classList.remove('resizing'); // Remove visual indicator
      }
    });
  });
</script>
{% endblock %}
